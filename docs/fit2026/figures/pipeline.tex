\begin{figure}[t]
\centering
\resizebox{\columnwidth}{!}{%
\begin{tikzpicture}[
  node distance=0.55cm and 0.3cm,
  every node/.style={font=\small},
  box/.style={rectangle, draw, rounded corners=2pt, minimum width=2.2cm, minimum height=0.55cm, align=center, text width=2.2cm},
  io/.style={box, fill=gray!15},
  normal/.style={box, fill=blue!10},
  llm/.style={box, fill=violet!25},
  green/.style={box, fill=green!20},
  orange/.style={box, fill=orange!25},
  decision/.style={diamond, draw, aspect=2.2, fill=yellow!15, align=center, inner sep=1pt, font=\small},
  arr/.style={-{Stealth[length=2mm]}, thick},
]
% Main flow
\node[io] (url) {URL入力};
\node[normal, below=of url] (fetch) {HTML取得};
\node[normal, below=of fetch] (compress) {HTML圧縮\\{\scriptsize (97\%削減)}};
\node[llm, below=of compress] (llm) {LLM推論\\{\scriptsize (Gemini, 1回)}};
\node[normal, below=of llm] (validate) {複数ページ\\検証};
\node[decision, below=0.7cm of validate] (branch) {\scriptsize 複数一致?};

% Center: AI再推論 directly below diamond
\node[orange, below=0.8cm of branch] (airef) {AI\\再推論};

% Left branch: 機械的絞り込み
\node[green, left=1.3cm of airef] (mech) {機械的\\絞り込み\\{\scriptsize (AI費用ゼロ)}};

% Re-validate below AI再推論
\node[normal, below=0.6cm of airef] (reval) {再検証};
\node[io, below=of reval] (final) {最終\\マッピング};
\node[normal, below=of final] (aladdin) {Aladdin\\{\scriptsize (10ページ検証)}};
\node[io, below=of aladdin] (export) {エクスポート};

% Arrows - main flow
\draw[arr] (url) -- (fetch);
\draw[arr] (fetch) -- (compress);
\draw[arr] (compress) -- (llm);
\draw[arr] (llm) -- (validate);
\draw[arr] (validate) -- (branch);

% Branch: 異なる値 → AI再推論 (straight down center)
\draw[arr] (branch) -- node[right, font=\scriptsize] {異なる値} (airef);

% Branch: 同一値 → 機械的絞り込み (left)
\draw[arr] (branch) -| node[near start, left, font=\scriptsize, yshift=5pt] {同一値} (mech);

% 機械的絞り込み → 再検証 (from bottom)
\draw[arr] (mech.south) |- (reval);

% AI再推論 → 再検証 (straight down)
\draw[arr] (airef) -- (reval);

% "なし" bypasses via right side to final mapping
\draw[arr] (branch.east) -- ++(1.2,0) node[above, font=\scriptsize] {なし} |- (final.east);

% Bottom flow
\draw[arr] (reval) -- (final);
\draw[arr] (final) -- (aladdin);
\draw[arr] (aladdin) -- (export);
\end{tikzpicture}%
}
\caption{XPathGenieシステムパイプライン}
\ecaption{XPathGenie system pipeline.}
\label{fig:pipeline}
\end{figure}
