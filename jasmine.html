<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XPath Jasmine â€” Section Selector</title>
<script>
const i18n = {
  ja: {
    urlPlaceholder: 'URLã‚’å…¥åŠ›...',
    fetch: 'èª­ã¿è¾¼ã¿',
    reset: 'ãƒªã‚»ãƒƒãƒˆ',
    analyze: 'åˆ†æå®Ÿè¡Œ',
    formTab: 'ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›',
    addField: 'ï¼‹ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ',
    fieldName: 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å',
    fieldExample: 'ä¾‹é¡Œï¼ˆä»»æ„ï¼‰',
    clear: 'ã‚¯ãƒªã‚¢',
    save: 'ä¿å­˜',
    tipClick: 'ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠï¼ˆç·‘ï¼‰',
    tipShift: 'ğŸ’¡ Shift+ã‚¯ãƒªãƒƒã‚¯ã§é™¤å¤–ï¼ˆèµ¤ï¼‰',
    modeIdle: 'ãƒ¢ãƒ¼ãƒ‰: å¾…æ©Ÿä¸­',
    modeSelecting: 'ãƒ¢ãƒ¼ãƒ‰: ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠä¸­',
    modeReady: 'ãƒ¢ãƒ¼ãƒ‰: åˆ†ææº–å‚™å®Œäº†',
    modeAnalyzing: 'ãƒ¢ãƒ¼ãƒ‰: åˆ†æä¸­...',
    selections: 'ğŸ“‹ é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³',
    noSelection: 'ã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“',
    results: 'ğŸ“Š åˆ†æçµæœ',
    copyJson: 'ğŸ“‹ JSONã‚³ãƒ”ãƒ¼',
    copied: 'âœ… ã‚³ãƒ”ãƒ¼ã—ãŸï¼',
    spinnerText: 'âœ¨ é©šç•°ã®å¤§å®‡å®™ãƒ‘ãƒ¯ãƒ¼ï¼âœ¨',
    statusInit: 'URLã‚’å…¥ã‚Œã¦ã­ âœ¨',
    statusEnterUrl: 'URLã‚’å…¥åŠ›ã—ã¦ã€Œèª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯',
    statusNoUrl: 'URLã‚’å…¥ã‚Œã¦ã­ï¼âœ¨',
    statusLoading: 'ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã§ã‚‹ã‚ˆâ€¦ğŸ”',
    statusLoadingShort: 'èª­ã¿è¾¼ã¿ä¸­...',
    statusError: 'ã‚ã‚Œï¼Ÿã‚¨ãƒ©ãƒ¼ã ã‚ˆâ€¦',
    statusLoadError: 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼',
    statusLoaded: 'èª­ã¿è¾¼ã‚ãŸã‚ˆï¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸ã‚“ã§ã­ âœ¨',
    statusAnalyzing: 'Genieã«èã„ã¦ã‚‹ã‚ˆâ€¦ğŸ§',
    statusFailed: 'ã†ã¾ãã„ã‹ãªã‹ã£ãŸâ€¦',
    statusSuccess: (n) => `ã‚„ã£ãŸã­ï¼${n}ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¦‹ã¤ã‘ãŸã‚ˆ âœ¨ â†’ <a href="aladdin.html" style="color:#fff; font-weight:bold; text-decoration:none;">Aladdin</a>ã«æ¸¡ã—ãŸã‚ˆï¼`,
    noValue: '(å€¤ãªã—)',
    multiMatch: 'âš  è¤‡æ•°ãƒãƒƒãƒ',
    selectUpTo: 'ã“ã“ã¾ã§é¸æŠ',
    jsonInvalid: 'JSONãŒä¸æ­£ã§ã™',
    error: 'ã‚¨ãƒ©ãƒ¼',
  },
  en: {
    urlPlaceholder: 'Enter URL...',
    fetch: 'Fetch',
    reset: 'Reset',
    analyze: 'Analyze',
    formTab: 'ğŸ“ Form Input',
    addField: 'ï¼‹ Add Field',
    fieldName: 'Field name',
    fieldExample: 'Example (optional)',
    clear: 'Clear',
    save: 'Save',
    tipClick: 'ğŸ’¡ Click to select main content (green)',
    tipShift: 'ğŸ’¡ Shift+click to exclude (red)',
    modeIdle: 'Mode: Idle',
    modeSelecting: 'Mode: Selecting',
    modeReady: 'Mode: Ready',
    modeAnalyzing: 'Mode: Analyzing...',
    selections: 'ğŸ“‹ Selections',
    noSelection: 'No sections selected yet',
    results: 'ğŸ“Š Results',
    copyJson: 'ğŸ“‹ Copy JSON',
    copied: 'âœ… Copied!',
    spinnerText: 'âœ¨ Cosmic Genie Power! âœ¨',
    statusInit: 'Enter a URL âœ¨',
    statusEnterUrl: 'Enter a URL and click "Fetch"',
    statusNoUrl: 'Please enter a URL! âœ¨',
    statusLoading: 'Loading pageâ€¦ ğŸ”',
    statusLoadingShort: 'Loading...',
    statusError: 'Oops! Error',
    statusLoadError: 'Load error',
    statusLoaded: 'Loaded! Click sections to select âœ¨',
    statusAnalyzing: 'Asking Genieâ€¦ ğŸ§',
    statusFailed: 'Something went wrongâ€¦',
    statusSuccess: (n) => `Found ${n} fields âœ¨ â†’ Passed to <a href="aladdin.html" style="color:#fff; font-weight:bold; text-decoration:none;">Aladdin</a>!`,
    noValue: '(no value)',
    multiMatch: 'âš  Multiple matches',
    selectUpTo: 'Select up to here',
    jsonInvalid: 'Invalid JSON',
    error: 'Error',
  }
};
let currentLang = localStorage.getItem('xpg_lang') || (navigator.language.startsWith('ja') ? 'ja' : 'en');
function t(key) { return i18n[currentLang][key] || i18n['ja'][key] || key; }
</script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a14; color: #e0d0f0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }

/* Header */
.header { padding: 12px 20px; background: #12101f; border-bottom: 1px solid #2a1a3a; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
.header h1 { font-size: 1.2rem; background: linear-gradient(135deg, #b366ff, #ffd700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; white-space: nowrap; }
.header input { flex: 1; padding: 8px 12px; background: #1a1a2a; border: 1px solid #3a2a5a; border-radius: 6px; color: #e0d0f0; font-size: 0.9rem; }
.header input:focus { outline: none; border-color: #b366ff; }
.header button { padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600; }
.btn-fetch { background: #b366ff; color: white; }
.btn-fetch:hover { background: #9944ee; }
.btn-analyze { background: #ffd700; color: #0a0a14; }
.btn-analyze:hover { background: #eec600; }
.btn-analyze:disabled { background: #4a4a3a; color: #8a8a6a; cursor: not-allowed; }
.btn-reset { background: #3a2a5a; color: #e0d0f0; }
.btn-reset:hover { background: #4a3a6a; }

/* Info bar */
.info-bar { padding: 8px 20px; background: #1a1a2a; border-bottom: 1px solid #2a1a3a; font-size: 0.85rem; color: #8a7aaa; display: flex; gap: 20px; flex-shrink: 0; }
.info-bar .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
.badge-include { background: rgba(0, 200, 100, 0.2); color: #00c864; }
.badge-exclude { background: rgba(255, 80, 80, 0.2); color: #ff5050; }
.badge-mode { background: rgba(179, 102, 255, 0.2); color: #b366ff; }

/* Main content */
.main { flex: 1; display: flex; flex-direction: row-reverse; overflow: hidden; }

/* Preview panel */
.preview-panel { flex: 1; position: relative; overflow: hidden; }
.preview-panel iframe { width: 100%; height: 100%; border: none; background: white; }
.loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #8a7aaa; font-size: 1.1rem; }

/* Side panel */
.side-panel { width: 320px; background: #12101f; border-right: 1px solid #2a1a3a; overflow-y: auto; flex-shrink: 0; padding: 16px; }
.side-panel h3 { color: #ffd700; font-size: 0.95rem; margin-bottom: 12px; }
.selection-list { list-style: none; }
.selection-list li { padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; font-size: 0.8rem; font-family: monospace; word-break: break-all; }
.selection-list li.include { background: rgba(0, 200, 100, 0.1); border: 1px solid rgba(0, 200, 100, 0.3); color: #00c864; }
.selection-list li.exclude { background: rgba(255, 80, 80, 0.1); border: 1px solid rgba(255, 80, 80, 0.3); color: #ff5050; }
.selection-list li .remove { float: right; cursor: pointer; opacity: 0.5; }
.selection-list li .remove:hover { opacity: 1; }
.selection-list .parent-part:hover { opacity: 1 !important; color: #50ff96 !important; }

/* Result panel */
.result-section { margin-top: 16px; }
.result-section h3 { color: #b366ff; }
.result-field { padding: 6px 0; border-bottom: 1px solid #2a1a3a; font-size: 0.8rem; }
.result-field .fname { color: #ffd700; }
.result-field .fxpath { color: #8a7aaa; font-family: monospace; font-size: 0.7rem; word-break: break-all; }
.result-field.multi-warn { border-left: 3px solid #ff9800; padding-left: 8px; }

/* Status */
.status { padding: 12px 20px; background: #12101f; border-top: 1px solid #2a1a3a; font-size: 0.85rem; color: #8a7aaa; flex-shrink: 0; }
</style>
</head>
<body>

<div class="header">
  <h1>âœ¨ XPath Jasmine</h1>
  <button onclick="document.getElementById('wantListModal').style.display='flex'" style="padding:8px 12px; background:#2a1a3a; border:1px solid #b366ff; border-radius:6px; color:#b366ff; font-size:0.8rem; cursor:pointer;">ğŸ“‹ Want List</button>
  <input type="password" id="apiKeyInput" placeholder="Gemini API Key" style="width:180px; padding:8px 12px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:6px; color:#e0d0f0; font-size:0.8rem; font-family:monospace;" title="Gemini API Key">
  <button onclick="toggleKeyVis()" style="padding:8px; background:none; border:1px solid #3a2a5a; border-radius:6px; cursor:pointer; font-size:0.9rem;" title="Show/Hide key" id="keyVisBtn">ğŸ‘</button>
  <a href="setup-guide.html" style="color:#b366ff; font-size:0.75rem; text-decoration:none; white-space:nowrap;" title="How to get a key">ğŸ”‘?</a>
  <label style="font-size:0.7rem; color:#6a5a8a; display:flex; align-items:center; gap:3px; white-space:nowrap; cursor:pointer;"><input type="checkbox" id="rememberKeyCb"> Remember</label>
  <input type="text" id="urlInput" placeholder="URLã‚’å…¥åŠ›..." value="">
  <button class="btn-fetch" onclick="fetchPage()" id="btnFetch">èª­ã¿è¾¼ã¿</button>
  <button class="btn-reset" onclick="resetSelections()" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="btn-analyze" id="analyzeBtn" onclick="analyze()" disabled>åˆ†æå®Ÿè¡Œ</button>
</div>

<!-- Want List Modal -->
<div id="wantListModal" onclick="if(event.target===this)this.style.display='none'" style="display:none; position:fixed; inset:0; z-index:10001; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
  <div style="background:#12101f; border:1px solid #3a2a5a; border-radius:12px; padding:20px; width:90%; max-width:560px; max-height:80vh; overflow-y:auto;">
    <h3 style="color:#ffd700; margin-bottom:12px;">ğŸ“‹ Want List</h3>
    <!-- Tabs -->
    <div style="display:flex; gap:0; margin-bottom:12px;">
      <button onclick="switchWLTab('form')" id="wlTabForm" style="flex:1; padding:8px; background:#b366ff; border:1px solid #3a2a5a; border-radius:6px 0 0 6px; color:#fff; font-weight:600; cursor:pointer; font-size:0.8rem;">ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›</button>
      <button onclick="switchWLTab('json')" id="wlTabJson" style="flex:1; padding:8px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:0 6px 6px 0; color:#8a7aaa; cursor:pointer; font-size:0.8rem;">{ } JSON</button>
    </div>
    <!-- Form tab -->
    <div id="wlFormTab">
      <div id="wlFields" style="display:flex; flex-direction:column; gap:6px;"></div>
      <button onclick="addWLField()" style="margin-top:8px; padding:6px 12px; background:#1a1a2a; border:1px dashed #3a2a5a; border-radius:6px; color:#b366ff; cursor:pointer; font-size:0.8rem; width:100%;">ï¼‹ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ </button>
    </div>
    <!-- JSON tab -->
    <div id="wlJsonTab" style="display:none;">
      <textarea id="wantListJsonInput" rows="10" placeholder='{"job_title": "è–¬å‰¤å¸«", "salary": "å¹´å500ä¸‡å††", ...}' style="width:100%; padding:10px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:6px; color:#e0d0f0; font-size:0.8rem; font-family:monospace; resize:vertical;"></textarea>
    </div>
    <!-- Buttons -->
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button onclick="clearWantList()" style="padding:8px 16px; background:#2a1a2a; border:1px solid #4a3a5a; border-radius:6px; color:#8a7aaa; cursor:pointer;">ã‚¯ãƒªã‚¢</button>
      <button onclick="saveWantList()" style="padding:8px 16px; background:#b366ff; border:none; border-radius:6px; color:#fff; font-weight:600; cursor:pointer;">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="keyNotice" style="display:none; padding:4px 20px; background:#0f0f1a; font-size:0.7rem; color:#555; line-height:1.5; border-bottom:1px solid #1a1a2a;">Your API key is stored in your browser's local storage. While convenient, it could be accessed by browser extensions or XSS attacks. You can regenerate your key anytime at <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener" style="color:#7c5cfc;">Google AI Studio</a>. Uncheck to keep the key in memory only (cleared when you close the tab).</div>
<script>document.addEventListener('DOMContentLoaded',()=>{if(localStorage.getItem('xpathgenie_remember_key')==='1')document.getElementById('keyNotice').style.display='block';});</script>
<div class="info-bar">
  <span>ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠï¼ˆç·‘ï¼‰</span>
  <span>ğŸ’¡ Shift+ã‚¯ãƒªãƒƒã‚¯ã§é™¤å¤–ï¼ˆèµ¤ï¼‰</span>
  <span class="badge badge-mode" id="modeLabel">ãƒ¢ãƒ¼ãƒ‰: å¾…æ©Ÿä¸­</span>
  <span style="margin-left:auto; font-size:0.8rem;"><a href="index.html" style="color:#7c5cfc; text-decoration:none; margin-right:10px;">Genie (Generate)</a><a href="aladdin.html" style="color:#7c5cfc; text-decoration:none; margin-right:10px;">Aladdin (Analyze)</a><a href="whitepaper.html" style="color:#7c5cfc; text-decoration:none; margin-right:10px;">Whitepaper</a><button id="langToggle" onclick="toggleLang()" style="padding:2px 8px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:4px; color:#8a7aaa; font-size:0.75rem; cursor:pointer; vertical-align:middle;">ğŸŒ EN</button></span>
</div>

<div class="main">
  <div class="preview-panel" id="previewPanel">
    <div class="loading" id="loadingMsg">URLã‚’å…¥åŠ›ã—ã¦ã€Œèª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
    <iframe id="previewFrame" style="display:none;"></iframe>
  </div>
  
  <div class="side-panel">
    <h3>ğŸ“‹ é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³</h3>
    <ul class="selection-list" id="selectionList">
      <li style="color: #6a5a8a; border: 1px dashed #2a1a3a; background: none;">ã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</li>
    </ul>
    
    <div class="result-section" id="resultSection" style="display:none;">
      <h3 style="display:inline;">ğŸ“Š åˆ†æçµæœ</h3> <button id="copyBtn" onclick="copyResults(this)" style="padding:4px 10px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:6px; color:#b366ff; font-size:0.75rem; cursor:pointer; vertical-align:middle;" onmouseover="this.style.background='#2a1a3a';this.style.borderColor='#b366ff'" onmouseout="this.style.background='#1a1a2a';this.style.borderColor='#3a2a5a'">ğŸ“‹ JSONã‚³ãƒ”ãƒ¼</button>
      <div id="resultFields"></div>
    </div>
  </div>
</div>

<!-- Spinner overlay -->
<div id="spinnerOverlay" style="display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; flex-direction:column; gap:12px;">
  <img src="wallpapers/images/genie_full.png" style="height:300px; animation:float 2s ease-in-out infinite; filter:drop-shadow(0 0 20px rgba(179,102,255,0.5));">
  <div style="color:#ffd700; font-size:1.1rem; font-weight:600; text-shadow:0 0 10px rgba(179,102,255,0.5); animation:pulse 1.5s ease-in-out infinite;">âœ¨ é©šç•°ã®å¤§å®‡å®™ãƒ‘ãƒ¯ãƒ¼ï¼âœ¨</div>
</div>
<style>
@keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-15px); } }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.6; } }
</style>

<!-- Speech bubble -->
<div id="statusBar" style="position:fixed; bottom:50px; right:190px; z-index:10000; background:rgba(26,26,46,0.5); border:1px solid rgba(58,42,90,0.5); border-radius:12px 12px 0 12px; padding:8px 14px; font-size:0.85rem; color:#e0d0f0; max-width:280px; overflow-wrap:break-word; word-break:break-word;">
  URLã‚’å…¥ã‚Œã¦ã­ âœ¨
</div>
<!-- Jasmine mascot (original position) -->
<div style="position:fixed; bottom:0; right:0; height:300px; width:200px; z-index:9999; pointer-events:none; overflow:hidden;">
  <img src="wallpapers/images/jasmine_bustup.png" style="height:400px; position:absolute; bottom:-200px; right:0;" />
</div>

<script>
const API_BASE = '/xpathgenie';

// API Key management
let _rememberKey = localStorage.getItem('xpathgenie_remember_key') === '1';
(function() {
  const saved = _rememberKey ? (localStorage.getItem('xpathgenie_api_key') || '') : '';
  document.addEventListener('DOMContentLoaded', () => {
    const inp = document.getElementById('apiKeyInput');
    const cb = document.getElementById('rememberKeyCb');
    if (inp) {
      inp.value = saved;
      inp.addEventListener('change', () => { if (_rememberKey) localStorage.setItem('xpathgenie_api_key', inp.value); });
    }
    if (cb) {
      cb.checked = _rememberKey;
      cb.addEventListener('change', () => {
        _rememberKey = cb.checked;
        localStorage.setItem('xpathgenie_remember_key', _rememberKey ? '1' : '0');
        if (_rememberKey) localStorage.setItem('xpathgenie_api_key', inp.value);
        else localStorage.removeItem('xpathgenie_api_key');
        document.getElementById('keyNotice').style.display = _rememberKey ? 'block' : 'none';
      });
    }
  });
})();
function toggleKeyVis() {
  const inp = document.getElementById('apiKeyInput');
  const btn = document.getElementById('keyVisBtn');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'ğŸ™ˆ'; }
  else { inp.type = 'password'; btn.textContent = 'ğŸ‘'; }
}
function getApiKey() { return (document.getElementById('apiKeyInput')?.value || '').trim(); }

let wlCurrentTab = 'form';

function switchWLTab(tab) {
  wlCurrentTab = tab;
  document.getElementById('wlFormTab').style.display = tab === 'form' ? 'block' : 'none';
  document.getElementById('wlJsonTab').style.display = tab === 'json' ? 'block' : 'none';
  document.getElementById('wlTabForm').style.background = tab === 'form' ? '#b366ff' : '#1a1a2a';
  document.getElementById('wlTabForm').style.color = tab === 'form' ? '#fff' : '#8a7aaa';
  document.getElementById('wlTabJson').style.background = tab === 'json' ? '#b366ff' : '#1a1a2a';
  document.getElementById('wlTabJson').style.color = tab === 'json' ? '#fff' : '#8a7aaa';
  // Sync between tabs
  if (tab === 'json') {
    document.getElementById('wantListJsonInput').value = JSON.stringify(getWLFromForm(), null, 2);
  } else {
    try {
      const obj = JSON.parse(document.getElementById('wantListJsonInput').value);
      loadWLToForm(obj);
    } catch(e) {}
  }
}

function addWLField(key, val) {
  const row = document.createElement('div');
  row.style.cssText = 'display:flex; gap:6px; align-items:center;';
  row.innerHTML = `<input type="text" placeholder="${t('fieldName')}" value="${key||''}" style="flex:1; padding:6px 8px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:4px; color:#ffd700; font-size:0.8rem;">
    <input type="text" placeholder="${t('fieldExample')}" value="${val||''}" style="flex:1; padding:6px 8px; background:#1a1a2a; border:1px solid #3a2a5a; border-radius:4px; color:#a0d0a0; font-size:0.8rem;">
    <button onclick="this.parentElement.remove()" style="background:none; border:none; color:#ff5050; cursor:pointer; font-size:1rem;">âœ•</button>`;
  document.getElementById('wlFields').appendChild(row);
}

function getWLFromForm() {
  const wl = {};
  document.querySelectorAll('#wlFields > div').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const k = inputs[0].value.trim();
    if (k) wl[k] = inputs[1].value.trim();
  });
  return wl;
}

function loadWLToForm(obj) {
  document.getElementById('wlFields').innerHTML = '';
  Object.entries(obj).forEach(([k, v]) => addWLField(k, v));
}

let lastMappings = null;

function copyResults(btn) {
  if (!lastMappings) return;
  const simple = {};
  Object.entries(lastMappings).forEach(([k, v]) => { simple[k] = v.xpath || v; });
  const json = JSON.stringify(simple, null, 2);
  navigator.clipboard.writeText(json).then(() => {
    btn.textContent = t('copied');
    setTimeout(() => { btn.textContent = t('copyJson'); }, 1500);
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = json; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    btn.textContent = t('copied');
    setTimeout(() => { btn.textContent = t('copyJson'); }, 1500);
  });
}

function saveWantList() {
  let wl;
  if (wlCurrentTab === 'json') {
    try { wl = JSON.parse(document.getElementById('wantListJsonInput').value); } catch(e) { alert(t('jsonInvalid')); return; }
  } else {
    wl = getWLFromForm();
  }
  if (Object.keys(wl).length > 0) {
    localStorage.setItem('xpathgenie_wantlist', JSON.stringify(wl));
  }
  document.getElementById('wantListModal').style.display = 'none';
}

function clearWantList() {
  document.getElementById('wlFields').innerHTML = '';
  document.getElementById('wantListJsonInput').value = '';
  localStorage.removeItem('xpathgenie_wantlist');
}

// Restore wantlist from localStorage
(function() {
  const saved = localStorage.getItem('xpathgenie_wantlist');
  if (saved) {
    try {
      const wl = JSON.parse(saved);
      loadWLToForm(wl);
    } catch(e) {}
  }
  if (!document.querySelectorAll('#wlFields > div').length) addWLField();
})();
let includeSelector = null;
let excludeSelectors = [];
let fetchedHTML = '';
let currentURL = '';

function setStatus(msg) {
  document.getElementById('statusBar').innerHTML = msg;
}

function setMode(mode) {
  const label = document.getElementById('modeLabel');
  if (mode !== 'analyzing') document.getElementById('spinnerOverlay').style.display = 'none';
  if (mode === 'selecting') {
    label.textContent = t('modeSelecting');
    label.style.color = '#00c864';
  } else if (mode === 'ready') {
    label.textContent = t('modeReady');
    label.style.color = '#ffd700';
  } else if (mode === 'analyzing') {
    label.textContent = t('modeAnalyzing');
    label.style.color = '#b366ff';
    document.getElementById('spinnerOverlay').style.display = 'flex';
  } else {
    label.textContent = t('modeIdle');
    label.style.color = '#b366ff';
  }
}

function getCSSSelector(el) {
  if (el.id) return `#${el.id}`;
  let path = [];
  while (el && el.nodeType === 1) {
    if (el.id) { path.unshift(`#${el.id}`); break; }
    if (el.tagName === 'BODY' || el.tagName === 'HTML') break;
    let selector = el.tagName.toLowerCase();
    if (el.className && typeof el.className === 'string') {
      const classes = el.className.trim().split(/\s+/).filter(c => c && !c.startsWith('xpg-'));
      if (classes.length > 0) {
        selector += '.' + classes.slice(0, 2).join('.');
      }
    }
    path.unshift(selector);
    el = el.parentElement;
  }
  return path.join(' > ');
}

function updateSelectionList() {
  const list = document.getElementById('selectionList');
  list.innerHTML = '';
  
  if (!includeSelector && excludeSelectors.length === 0) {
    list.innerHTML = `<li style="color: #6a5a8a; border: 1px dashed #2a1a3a; background: none;">${t('noSelection')}</li>`;
    document.getElementById('analyzeBtn').disabled = true;
    return;
  }
  
  if (includeSelector) {
    const li = document.createElement('li');
    li.className = 'include';
    const parts = includeSelector.split(' > ');
    const clickableParts = parts.map((part, i) => {
      const parentSel = parts.slice(0, i + 1).join(' > ');
      if (i === parts.length - 1) {
        return `<span style="color:#00c864; font-weight:600;">${part}</span>`;
      }
      return `<span class="parent-part" style="cursor:pointer; color:#00c864; opacity:0.6; text-decoration:underline dotted;" onclick="event.stopPropagation(); changeIncludeTo('${parentSel.replace(/'/g, "\\'")}')" title="${t('selectUpTo')}">${part}</span>`;
    }).join(' <span style="opacity:0.3;">&gt;</span> ');
    li.innerHTML = `<span class="remove" onclick="removeInclude()">âœ•</span>ğŸŸ¢ ${clickableParts}`;
    list.appendChild(li);
    document.getElementById('analyzeBtn').disabled = false;
    setMode('ready');
  }
  
  excludeSelectors.forEach((sel, i) => {
    const li = document.createElement('li');
    li.className = 'exclude';
    li.innerHTML = `<span class="remove" onclick="removeExclude(${i})">âœ•</span>ğŸ”´ ${sel}`;
    list.appendChild(li);
  });
}

function changeIncludeTo(newSelector) {
  const frame = document.getElementById('previewFrame');
  const doc = frame.contentDocument;
  if (doc) {
    // Remove old highlights
    doc.querySelectorAll('.xpg-include').forEach(e => e.classList.remove('xpg-include'));
    doc.querySelectorAll('.xpg-blackout').forEach(e => e.classList.remove('xpg-blackout'));
    // Apply new
    const el = doc.querySelector(newSelector);
    if (el) {
      el.classList.add('xpg-include');
      // Re-blackout siblings
      function blackoutSiblings(node) {
        if (!node.parentElement) return;
        const parent = node.parentElement;
        Array.from(parent.children).forEach(child => {
          if (child !== node && !child.classList.contains('xpg-exclude')) {
            child.classList.add('xpg-blackout');
          }
        });
        blackoutSiblings(parent);
      }
      blackoutSiblings(el);
    }
  }
  includeSelector = newSelector;
  updateSelectionList();
}

function removeInclude() {
  const frame = document.getElementById('previewFrame');
  const doc = frame.contentDocument;
  if (doc) {
    const el = doc.querySelector('.xpg-include');
    if (el) el.classList.remove('xpg-include');
    // Remove blackout
    doc.querySelectorAll('.xpg-blackout').forEach(e => e.classList.remove('xpg-blackout'));
  }
  includeSelector = null;
  setMode('selecting');
  updateSelectionList();
}

function removeExclude(index) {
  const frame = document.getElementById('previewFrame');
  const doc = frame.contentDocument;
  if (doc) {
    const els = doc.querySelectorAll('.xpg-exclude');
    if (els[index]) els[index].classList.remove('xpg-exclude');
  }
  excludeSelectors.splice(index, 1);
  updateSelectionList();
}

function resetSelections() {
  const frame = document.getElementById('previewFrame');
  const doc = frame.contentDocument;
  if (doc) {
    doc.querySelectorAll('.xpg-include, .xpg-exclude, .xpg-blackout').forEach(el => {
      el.classList.remove('xpg-include', 'xpg-exclude', 'xpg-blackout');
    });
  }
  includeSelector = null;
  excludeSelectors = [];
  setMode('selecting');
  updateSelectionList();
  document.getElementById('resultSection').style.display = 'none';
}

function applyBlackout(doc, includeEl) {
  // Blackout everything except the include element and its ancestors
  function blackoutSiblings(el) {
    if (!el || !el.parentElement) return;
    const parent = el.parentElement;
    Array.from(parent.children).forEach(child => {
      if (child !== el && !child.contains(includeEl) && child.tagName !== 'SCRIPT' && child.tagName !== 'STYLE') {
        child.classList.add('xpg-blackout');
      }
    });
    if (parent.tagName !== 'BODY' && parent.tagName !== 'HTML') {
      blackoutSiblings(parent);
    }
  }
  blackoutSiblings(includeEl);
}

async function fetchPage() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) { setStatus(t('statusNoUrl')); return; }
  
  currentURL = url;
  setStatus(t('statusLoading'));
  setMode('selecting');
  document.getElementById('loadingMsg').textContent = t('statusLoadingShort');
  document.getElementById('loadingMsg').style.display = 'block';
  document.getElementById('previewFrame').style.display = 'none';
  
  try {
    // Fetch via proxy API
    const resp = await fetch(`${API_BASE}/api/fetch?url=${encodeURIComponent(url)}`);
    const data = await resp.json();
    
    if (data.error || data.message) {
      const errMsg = data.error || data.message;
      setStatus(`${t('statusError')}: ${errMsg} ğŸ˜¢`);
      document.getElementById('loadingMsg').textContent = `${t('statusLoadError')}: ${errMsg}`;
      return;
    }
    
    fetchedHTML = data.html;
    
    // Inject into iframe
    const frame = document.getElementById('previewFrame');
    frame.style.display = 'block';
    document.getElementById('loadingMsg').style.display = 'none';
    
    // Add our styles and base tag
    const injectedCSS = `
      <style>
        .xpg-hover { outline: 3px dashed rgba(179, 102, 255, 0.7) !important; outline-offset: 2px !important; cursor: pointer !important; }
        .xpg-include { outline: 3px solid #00c864 !important; outline-offset: 2px !important; background-color: rgba(0, 200, 100, 0.05) !important; }
        .xpg-exclude { outline: 3px solid #ff5050 !important; outline-offset: 2px !important; background-color: rgba(255, 80, 80, 0.05) !important; }
        .xpg-blackout { opacity: 0.15 !important; filter: grayscale(1) brightness(0.3) !important; pointer-events: none !important; transition: all 0.3s !important; }
      </style>
      <base href="${new URL(url).origin}/" />
    `;
    
    const html = fetchedHTML.replace('</head>', injectedCSS + '</head>');
    frame.srcdoc = html;
    
    frame.onload = () => {
      const doc = frame.contentDocument;
      let hovered = null;
      
      // Hover effect
      doc.addEventListener('mouseover', (e) => {
        let target = e.target;
        // Walk up to a meaningful section-level element
        while (target && target.tagName !== 'BODY' && target.tagName !== 'HTML') {
          const tag = target.tagName.toLowerCase();
          if (['div', 'section', 'main', 'article', 'table', 'form', 'ul', 'ol', 'dl'].includes(tag)) {
            break;
          }
          target = target.parentElement;
        }
        if (!target || target.tagName === 'BODY' || target.tagName === 'HTML') return;
        
        if (hovered && hovered !== target) {
          hovered.classList.remove('xpg-hover');
        }
        if (!target.classList.contains('xpg-include') && !target.classList.contains('xpg-exclude')) {
          target.classList.add('xpg-hover');
        }
        hovered = target;
      });
      
      doc.addEventListener('mouseout', (e) => {
        if (hovered) {
          hovered.classList.remove('xpg-hover');
          hovered = null;
        }
      });
      
      // Click handler
      doc.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        let target = e.target;
        while (target && target.tagName !== 'BODY' && target.tagName !== 'HTML') {
          const tag = target.tagName.toLowerCase();
          if (['div', 'section', 'main', 'article', 'table', 'form', 'ul', 'ol', 'dl'].includes(tag)) {
            break;
          }
          target = target.parentElement;
        }
        if (!target || target.tagName === 'BODY' || target.tagName === 'HTML') return;
        
        target.classList.remove('xpg-hover');
        const selector = getCSSSelector(target);
        
        if (e.shiftKey) {
          // Exclude mode
          if (target.classList.contains('xpg-exclude')) {
            target.classList.remove('xpg-exclude');
            excludeSelectors = excludeSelectors.filter(s => s !== selector);
          } else {
            target.classList.add('xpg-exclude');
            excludeSelectors.push(selector);
          }
        } else {
          // Include mode
          // Remove previous include
          doc.querySelectorAll('.xpg-include').forEach(el => el.classList.remove('xpg-include'));
          doc.querySelectorAll('.xpg-blackout').forEach(el => el.classList.remove('xpg-blackout'));
          
          target.classList.add('xpg-include');
          includeSelector = selector;
          
          // Apply blackout
          applyBlackout(doc, target);
        }
        
        updateSelectionList();
      });
      
      setStatus(t('statusLoaded'));
    };
    
  } catch (err) {
    setStatus(`${t('error')}: ${err.message}`);
    document.getElementById('loadingMsg').textContent = `${t('error')}: ${err.message}`;
  }
}

async function analyze() {
  if (!includeSelector) return;
  
  setMode('analyzing');
  setStatus(t('statusAnalyzing'));
  document.getElementById('analyzeBtn').disabled = true;
  
  try {
    const ak = getApiKey();
    if (!ak) { setStatus('Please enter your Gemini API key ğŸ”‘'); setMode('ready'); document.getElementById('analyzeBtn').disabled = false; return; }
    const payload = {
      urls: [currentURL],
      selector: includeSelector,
    };
    if (excludeSelectors.length > 0) {
      payload.exclude = excludeSelectors;
    }
    const wantlist = getWLFromForm();
    if (Object.keys(wantlist).length > 0) {
      payload.wantlist = wantlist;
    }
    
    const resp = await fetch(`${API_BASE}/api/analyze`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + ak,
      },
      body: JSON.stringify(payload),
    });
    const data = await resp.json();
    
    if (data.status === 'error') {
      setStatus(`${t('statusFailed')}: ${data.reason} â€” ${data.message || ''}`);
      document.getElementById('analyzeBtn').disabled = false;
      return;
    }
    
    // Show results
    const resultSection = document.getElementById('resultSection');
    const resultFields = document.getElementById('resultFields');
    resultFields.innerHTML = '';
    
    const mappings = data.mappings || {};
    lastMappings = mappings;
    const count = Object.keys(mappings).length;
    
    Object.entries(mappings).forEach(([field, info]) => {
      const div = document.createElement('div');
      const hasWarning = info.warning ? true : false;
      div.className = 'result-field' + (hasWarning ? ' multi-warn' : '');
      const val = (info.samples && info.samples[0]) ? info.samples[0] : t('noValue');
      const warnBadge = hasWarning ? `<span style="color:#ff9800; font-size:0.75rem; margin-left:6px;">${t('multiMatch')}</span>` : '';
      div.innerHTML = `<div class="fname">${field}${warnBadge}</div><div class="fval" style="color:#a0d0a0; font-size:0.85rem; word-break:break-all;">${val}</div>`;
      resultFields.appendChild(div);
    });
    
    resultSection.style.display = 'block';
    
    // Share with Aladdin via localStorage
    const url = document.getElementById('urlInput').value.trim();
    localStorage.setItem('xpathgenie_urls', url);
    const mappingObj = {};
    Object.entries(mappings).forEach(([f, info]) => { mappingObj[f] = info.xpath; });
    localStorage.setItem('xpathgenie_mappings', JSON.stringify(mappingObj));
    
    setStatus(t('statusSuccess')(count));
    setMode('ready');
    document.getElementById('analyzeBtn').disabled = false;
    
  } catch (err) {
    setStatus(`${t('error')}: ${err.message}`);
    document.getElementById('analyzeBtn').disabled = false;
  }
}

function toggleLang() {
  currentLang = currentLang === 'ja' ? 'en' : 'ja';
  localStorage.setItem('xpg_lang', currentLang);
  applyLang();
}

function applyLang() {
  const btn = document.getElementById('langToggle');
  btn.textContent = currentLang === 'ja' ? 'ğŸŒ EN' : 'ğŸŒ JA';
  document.getElementById('urlInput').placeholder = t('urlPlaceholder');
  document.getElementById('btnFetch').textContent = t('fetch');
  document.getElementById('btnReset').textContent = t('reset');
  document.getElementById('analyzeBtn').textContent = t('analyze');
  // Info bar
  const infoSpans = document.querySelectorAll('.info-bar > span');
  if (infoSpans[0]) infoSpans[0].textContent = t('tipClick');
  if (infoSpans[1]) infoSpans[1].textContent = t('tipShift');
  // Mode label keeps its current state â€” just update prefix
  // Side panel
  const sideTitles = document.querySelectorAll('.side-panel h3');
  if (sideTitles[0]) sideTitles[0].textContent = t('selections');
  // Result section header
  const resultH3 = document.querySelector('.result-section h3');
  if (resultH3) resultH3.textContent = t('results');
  // Copy button
  const copyBtn = document.getElementById('copyBtn');
  if (copyBtn && !copyBtn.textContent.includes('âœ…')) copyBtn.textContent = t('copyJson');
  // Spinner
  const spinnerText = document.querySelector('#spinnerOverlay > div:last-child');
  if (spinnerText) spinnerText.textContent = t('spinnerText');
  // Status bar
  const statusBar = document.getElementById('statusBar');
  if (statusBar.textContent.includes('URLã‚’å…¥ã‚Œã¦ã­') || statusBar.textContent.includes('Enter a URL âœ¨')) {
    setStatus(t('statusInit'));
  }
  // Loading msg
  const loadingMsg = document.getElementById('loadingMsg');
  if (loadingMsg && (loadingMsg.textContent.includes('URLã‚’å…¥åŠ›') || loadingMsg.textContent.includes('Enter a URL'))) {
    loadingMsg.textContent = t('statusEnterUrl');
  }
  // Want List modal
  const wlFormBtn = document.getElementById('wlTabForm');
  if (wlFormBtn) wlFormBtn.textContent = t('formTab');
  // Add field button
  const addBtn = document.querySelector('#wlFormTab > button');
  if (addBtn) addBtn.textContent = t('addField');
  // Clear/Save buttons
  const modalBtns = document.querySelectorAll('#wantListModal .modal-actions button, #wantListModal div:last-child > div:last-child > button');
  // No selection msg
  const noSelLi = document.querySelector('#selectionList li[style]');
  if (noSelLi && (noSelLi.textContent.includes('ã¾ã ') || noSelLi.textContent.includes('No sections'))) {
    noSelLi.textContent = t('noSelection');
  }
  document.documentElement.lang = currentLang;
}
// Apply on load
document.addEventListener('DOMContentLoaded', applyLang);
</script>

</body>
</html>
