<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XPathGenie</title>
  <link rel="stylesheet" href="static/css/style.css">
  <script src="https://unpkg.com/vue@3.5.28/dist/vue.global.prod.js" integrity="sha384-EyKhbIJoP1t1fKIFRNEfYKy4uy8qxs7UNS4Cab53xyXqCTUB1PCoxeFsD0G/NX9W" crossorigin="anonymous"></script>
</head>
<body>
  <div id="app">
    <div class="container">
      <header class="hero">
        
        <img src="static/images/genie.png" class="genie" alt="Genie">
        <h1>XPathGenie</h1>
        <p class="tagline">Rub the lamp, get the XPath.</p>
      <nav class="nav-pair"><span class="current">Genie (Generate)</span> <a href="aladdin.html">Aladdin (Research)</a></nav>
      </header>

      <div class="card input-card">
        <div class="api-key-row">
          <label>Gemini API Key <a href="setup-guide.html" class="hint" style="margin-left:6px;">How to get one?</a></label>
          <div class="api-key-input-wrap">
            <input :type="showKey ? 'text' : 'password'" v-model="apiKey" placeholder="AIza..." class="api-key-input" @change="saveApiKey">
            <button @click="showKey=!showKey" class="btn-toggle-key" :title="showKey ? 'Hide' : 'Show'">{{ showKey ? 'üôà' : 'üëÅ' }}</button>
          </div>
          <label class="remember-key-label"><input type="checkbox" v-model="rememberKey"> Remember API key</label>
          <p v-if="rememberKey" class="api-key-notice">Your API key is stored in your browser's local storage. While convenient, it could be accessed by browser extensions or XSS attacks. You can regenerate your key anytime at <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Google AI Studio</a>. Uncheck to keep the key in memory only (cleared when you close the tab).</p>
        </div>
        <label>Enter URLs <span class="hint">(one per line, 2-10 recommended)</span></label>
        <textarea v-model="urlText" placeholder="https://example.com/page/1&#10;https://example.com/page/2&#10;https://example.com/page/3" rows="5" :disabled="loading"></textarea>

        <div class="mode-toggle">
          <button @click="mode='discover'" :class="{active: mode==='discover'}" class="mode-btn">Auto Discover</button>
          <button @click="mode='wantlist'" :class="{active: mode==='wantlist'}" class="mode-btn">Want List</button>
        </div>

        <div v-if="mode==='wantlist'" class="wantlist-section">
          <label>Want List <span class="hint">(JSON schema ‚Äî keys = desired field names)</span></label>
          <textarea v-model="wantlistText" :placeholder="wantlistPlaceholder" rows="8" :disabled="loading" class="wantlist-input"></textarea>
        </div>

        <button @click="analyzeUrls" :disabled="loading || !urlText.trim()" class="btn-analyze">
          <span v-if="!loading">Analyze</span>
          <span v-else>Genie is working... {{ elapsedStr }}</span>
        </button>
      </div>

      <div v-if="error" class="card error-card">
        <strong>Error:</strong> {{ error }}
      </div>

      <div v-if="result" class="card result-card">
        <div class="result-header">
          <h2>{{ result.site }}</h2>
          <div class="stats">
            <span>{{ result.pages_analyzed }} pages</span>
            <span>{{ result.tokens_used }} tokens</span>
            <span>{{ result.elapsed_seconds }}s</span>
            <span v-if="savedAtStr" style="opacity:0.6">{{ savedAtStr }}</span>
          </div>
        </div>

        <table class="result-table">
          <thead>
            <tr>
              <th>Field</th>
              <th>XPath</th>
              <th>Confidence</th>
              <th>Samples</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(info, field) in result.mappings" :key="field" :class="{'low-confidence': info.confidence < 0.5}">
              <td>
                <input v-if="editing === field" v-model="editName" @keyup.enter="renameField(field)" @blur="renameField(field)" class="edit-input" ref="editInput">
                <span v-else @dblclick="startEdit(field)" class="field-name" :title="'Double-click to rename'">{{ field }}
                  <span v-if="result.refined_fields && result.refined_fields.includes(field)" class="refined-badge">refined</span>
                </span>
              </td>
              <td class="xpath-cell" :title="info.xpath">{{ info.xpath }}</td>
              <td>
                <div class="confidence-bar">
                  <div class="confidence-fill" :style="{width: (info.confidence*100)+'%', background: confidenceColor(info.confidence)}"></div>
                  <span>{{ Math.round(info.confidence*100) }}%</span>
                </div>
              </td>
              <td class="samples-cell">
                <span v-for="(s, i) in info.samples" :key="i" class="sample" :class="{missing: !s}">{{ s || '---' }}</span>
                <div v-if="info.warning" class="warning-msg">{{ info.warning }}</div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="export-bar">
          <button @click="copyJSON" class="btn-export">Copy JSON</button>
          <button @click="copyYAML" class="btn-export">Copy YAML</button>
          <button @click="openInAladdin" class="btn-export" style="background:linear-gradient(135deg,#7c5cfc,#9f7aea);color:#fff;">Open in Aladdin</button>
          <span v-if="copied" class="copied-msg">Copied!</span>
        </div>
      </div>
    </div>
  </div>
  <script src="static/js/app.js?v=4"></script>
</body>
</html>
