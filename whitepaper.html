<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src https://generativelanguage.googleapis.com 'self'; img-src 'self' data: https:; font-src 'self';">
<title>XPathGenie Whitepaper</title>
<!-- CDN imports -->
<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js" integrity="sha384-948ahk4ZmxYVYOc+rxN1H2gM1EJ2Duhp7uHtZ4WSLkV4Vtx5MUqnV+l7u9B+jFv+" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js" integrity="sha384-80VlBZnyAwkkqtSfg5NhPyZff6nU4K/qniLBL8Jnm4KDv6jZhLiYtJbhglg/i9ww" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js" integrity="sha384-jFhLSLFn4m565eRAS0CDMWubMqOtfZWWbE8kqgGdU+VHbJ3B2G/4X8u+0BM8MtdU" crossorigin="anonymous"></script>
<style>
/* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #0a0a14;
  color: #ffffff;
  line-height: 1.6;
}

.container {
  margin: 0;
  padding: 20px;
  padding-right: 340px; /* ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ãƒãƒ£ãƒƒãƒˆåˆ†ã®ä½™ç™½ */
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆJasmineé¢¨ãƒ•ãƒ«ãƒ¯ã‚¤ãƒ‰ï¼‰ */
.header {
  padding: 10px 20px;
  background: #12101f;
  border-bottom: 1px solid #2a1a3a;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 1001;
}

.header h1 {
  font-size: 1.2rem;
  margin: 0;
  background: linear-gradient(135deg, #b366ff, #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.nav-pair {
  display: flex;
  gap: 4px;
  font-size: 0.85rem;
}

.nav-pair a {
  color: #b366ff;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 6px;
  transition: background 0.2s;
}

.nav-pair a:hover {
  background: rgba(179, 102, 255, 0.1);
}

.nav-pair .current {
  color: #ffffff;
  background: #b366ff;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: bold;
}

.header .api-key-group {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: auto;
}

.header .api-key-group input[type="password"],
.header .api-key-group input[type="text"] {
  width: 180px;
  padding: 6px 10px;
  background: #1a1a2a;
  border: 1px solid #3a2a5a;
  border-radius: 6px;
  color: #e0d0f0;
  font-size: 0.8rem;
  font-family: monospace;
}

.header .api-key-group input:focus {
  outline: none;
  border-color: #b366ff;
}

.header .api-key-group button {
  padding: 6px 8px;
  background: none;
  border: 1px solid #3a2a5a;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
}

.header .api-key-group label {
  font-size: 0.7rem;
  color: #6a5a8a;
  display: flex;
  align-items: center;
  gap: 3px;
  white-space: nowrap;
  cursor: pointer;
}

/* ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */
.doc-tabs {
  display: flex;
  gap: 0;
  margin-bottom: 30px;
  border-bottom: 2px solid #2a2a5a;
}

.doc-tab {
  background: transparent;
  border: none;
  color: #8a8a8a;
  padding: 12px 24px;
  cursor: pointer;
  font-size: 16px;
  border-bottom: 2px solid transparent;
  transition: all 0.3s ease;
}

.doc-tab:hover {
  color: #b366ff;
  background: rgba(179, 102, 255, 0.05);
}

.doc-tab.active {
  color: #b366ff;
  border-bottom-color: #b366ff;
  font-weight: bold;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
.whitepaper-content {
  font-size: 16px;
  line-height: 1.7;
}

.whitepaper-content h1 {
  color: #b366ff;
  border-bottom: 2px solid #b366ff;
  padding-bottom: 10px;
}

.whitepaper-content h2 {
  color: #e0c3fc;
  margin-top: 40px;
  margin-bottom: 20px;
}

.whitepaper-content h3 {
  color: #c8a2fa;
  margin-top: 30px;
  margin-bottom: 15px;
}

.whitepaper-content pre {
  background: #1a1a2e;
  padding: 15px;
  border-radius: 8px;
  overflow-x: auto;
  border-left: 4px solid #b366ff;
}

.whitepaper-content code {
  background: #1a1a2e;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Fira Code', 'Courier New', monospace;
}

.whitepaper-content blockquote {
  border-left: 4px solid #b366ff;
  margin: 0;
  padding: 10px 20px;
  background: rgba(179, 102, 255, 0.05);
  border-radius: 0 8px 8px 0;
}

.whitepaper-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: #16213e;
  border-radius: 8px;
  overflow: hidden;
}

.whitepaper-content th,
.whitepaper-content td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #2a2a5a;
}

.whitepaper-content th {
  background: #b366ff;
  color: #ffffff;
  font-weight: bold;
}

.whitepaper-content tr:hover {
  background: rgba(179, 102, 255, 0.05);
}

/* ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ãƒãƒ£ãƒƒãƒˆUIï¼ˆå³ã‚«ãƒ©ãƒ å›ºå®šï¼‰ */
.jasmine-container {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 320px;
  height: 300px;
  z-index: 1000;
  pointer-events: none;
  overflow: hidden;
}

.jasmine-container > * {
  pointer-events: auto;
}

.jasmine-image {
  height: 400px;
  width: auto;
  position: absolute;
  bottom: -200px;
  right: 0;
}

.jasmine-bubble {
  position: absolute;
  bottom: 200px;
  right: 10px;
  left: 10px;
  background: #b366ff;
  color: #ffffff;
  padding: 12px 16px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  transition: all 0.5s ease;
  font-size: 0.85rem;
  animation: float 3s ease-in-out infinite;
}

.bubble-text {
  display: block;
}

#bubble-text-b, #bubble-text-c {
  display: none;
}

.jasmine-bubble.rotating #bubble-text-b,
.jasmine-bubble.rotating #bubble-text-c {
  display: block;
  opacity: 0;
}

.jasmine-bubble.rotating #bubble-text-b,
.jasmine-bubble.rotating #bubble-text-c {
  position: absolute;
  top: 12px; left: 16px; right: 16px;
}

.jasmine-bubble.rotating #bubble-text-a {
  animation: bubbleFade3 12s ease-in-out infinite;
}

.jasmine-bubble.rotating #bubble-text-b {
  animation: bubbleFade3 12s ease-in-out infinite;
  animation-delay: 4s;
}

.jasmine-bubble.rotating #bubble-text-c {
  animation: bubbleFade3 12s ease-in-out infinite;
  animation-delay: 8s;
}

@keyframes bubbleFade3 {
  0%, 28% { opacity: 1; }
  33%, 95% { opacity: 0; }
  100% { opacity: 1; }
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

.jasmine-bubble:hover {
  background: #a855f7;
  animation-play-state: paused;
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 6px 20px rgba(179, 102, 255, 0.4);
}

.jasmine-bubble::after {
  content: '';
  position: absolute;
  bottom: -8px;
  right: 40px;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid #b366ff;
}

.jasmine-bubble:hover::after {
  border-top-color: #a855f7;
}

/* ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ */
.chat-interface {
  position: fixed;
  bottom: 200px;
  right: 0;
  width: 320px;
  background: rgba(16, 33, 62, 0.95);
  border-radius: 15px 15px 0 0;
  display: none;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
}

.chat-interface.active {
  display: block;
}

.chat-header {
  background: #b366ff;
  color: #ffffff;
  padding: 15px 20px;
  border-radius: 15px 15px 0 0;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-close {
  background: none;
  border: none;
  color: #ffffff;
  font-size: 18px;
  cursor: pointer;
  padding: 0;
}

.chat-history {
  max-height: 400px;
  overflow-y: auto;
  padding: 8px;
}

.chat-message {
  margin-bottom: 10px;
}

.chat-message.user {
  text-align: right;
}

.chat-message.jasmine {
  text-align: left;
}

.chat-message-bubble {
  display: inline-block;
  max-width: 90%;
  padding: 8px 10px;
  border-radius: 12px;
  word-wrap: break-word;
  font-size: 0.85rem;
  line-height: 1.5;
}

.chat-message.user .chat-message-bubble {
  background: #4f46e5;
  color: #ffffff;
  border-bottom-right-radius: 5px;
}

.chat-message.jasmine .chat-message-bubble {
  background: #374151;
  color: #ffffff;
  border-bottom-left-radius: 5px;
}

.chat-input-area {
  padding: 8px;
  border-top: 1px solid #2a2a5a;
}

.chat-input-row {
  display: flex;
  gap: 10px;
}

.chat-input {
  flex: 1;
  padding: 10px;
  border: 1px solid #2a2a5a;
  border-radius: 20px;
  background: #1a1a2e;
  color: #ffffff;
  outline: none;
}

.chat-input:focus {
  border-color: #b366ff;
}

.chat-send {
  background: #b366ff;
  color: #ffffff;
  border: none;
  padding: 10px 20px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}

.chat-send:hover {
  background: #a855f7;
}

.chat-send:disabled {
  background: #666;
  cursor: not-allowed;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
.loading {
  opacity: 0.7;
}

/* Mermaidå›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.mermaid {
  text-align: center;
  margin: 20px 0;
}

/* ãƒãƒ£ãƒƒãƒˆå†…ã®Markdownã‚¹ã‚¿ã‚¤ãƒ« */
.chat-message-bubble p {
  margin: 0.3em 0;
}
.chat-message-bubble p:first-child {
  margin-top: 0;
}
.chat-message-bubble p:last-child {
  margin-bottom: 0;
}
.chat-message-bubble ul, .chat-message-bubble ol {
  margin: 0.3em 0;
  padding-left: 1.2em;
}
.chat-message-bubble blockquote {
  margin: 0.3em 0;
  padding-left: 0.8em;
  border-left: 2px solid #b366ff;
}
.chat-message-bubble pre {
  margin: 0.3em 0;
  padding: 6px 8px;
  overflow-x: auto;
  font-size: 0.8rem;
}
.chat-message-bubble a {
  color: #b366ff;
  text-decoration: underline;
}

/* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
@media (max-width: 768px) {
  .header {
    flex-wrap: wrap;
    gap: 8px;
  }
  .header .api-key-group {
    width: 100%;
    margin-left: 0;
  }
  .header .api-key-group input[type="password"],
  .header .api-key-group input[type="text"] {
    flex: 1;
    width: auto;
  }
  .container {
    padding-right: 10px;
    padding: 10px;
  }

  .jasmine-container {
    width: 80px;
  }

  .jasmine-image {
    width: 70px;
  }

  .jasmine-bubble {
    display: none;
  }

  #api-key-row {
    display: none !important;
  }

  .chat-interface {
    width: 100vw;
    right: 0;
    bottom: 0;
    border-radius: 15px 15px 0 0;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ç”»åƒã‚¿ãƒƒãƒ—ã§ãƒãƒ£ãƒƒãƒˆé–‹ã */
  .jasmine-image {
    cursor: pointer;
  }
}
</style>
<script src="static/js/common.js"></script>
</head>
<body>

<div class="header">
  <h1>âœ¨ XPathGenie</h1>
  <nav class="nav-pair">
    <a href="index.html">Genie</a>
    <a href="aladdin.html">Aladdin</a>
    <a href="jasmine.html">Jasmine</a>
    <span class="current">Whitepaper</span>
  </nav>
  <div class="api-key-group">
    <input type="password" id="wp-api-key" placeholder="Gemini API Key" title="Gemini API Key">
    <button onclick="document.getElementById('wp-api-key').type = document.getElementById('wp-api-key').type==='password'?'text':'password'" title="Show/Hide key" id="keyVisBtn">ğŸ‘</button>
    <a href="setup-guide.html" style="color:#b366ff; font-size:0.75rem; text-decoration:none; white-space:nowrap;" title="How to get a key">ğŸ”‘?</a>
    <label><input type="checkbox" id="rememberKeyCb"> Remember</label>
  </div>
</div>

<div class="container">
  <!-- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
  <div class="doc-tabs">
    <button class="doc-tab active" data-doc="whitepaper_jp">Whitepaper (JP)</button>
    <button class="doc-tab" data-doc="whitepaper">Whitepaper (EN)</button>
    <button class="doc-tab" data-doc="readme">README</button>
  </div>
  
  <!-- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="whitepaper-content" id="document-content">
    <div style="text-align: center; color: #b366ff; margin: 50px 0;">
      <h2>èª­ã¿è¾¼ã¿ä¸­...</h2>
    </div>
  </div>
</div>

<!-- ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ãƒãƒ£ãƒƒãƒˆUI -->
<div class="jasmine-container">
  <div class="jasmine-bubble" id="jasmine-bubble">
    <span id="bubble-text-a" class="bubble-text">æœ¬è«–æ–‡ã«ã¤ã„ã¦ã”è³ªå•ãŒã‚ã‚Œã°ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚</span>
    <span id="bubble-text-b" class="bubble-text"></span>
    <span id="bubble-text-c" class="bubble-text">ã€Œã“ã®å¹ãå‡ºã—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</span>
  </div>

  <img src="wallpapers/images/jasmine_bustup.png" alt="Jasmine" class="jasmine-image">
  
  <div class="chat-interface" id="chat-interface">
    <div class="chat-header">
      <span>Jasmine â€” Research Assistant</span>
      <button class="chat-close" id="chat-close">&times;</button>
    </div>
    
    <div class="chat-history" id="chat-history">
      <div class="chat-message jasmine">
        <div class="chat-message-bubble">
          æœ¬è«–æ–‡ã®å†…å®¹ã«ã¤ã„ã¦ã”è³ªå•ã‚’ãŠå—ã‘ã„ãŸã—ã¾ã™ã€‚<br>
          è©²å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ãªãŒã‚‰ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚
        </div>
      </div>
    </div>
    
    <div class="chat-input-area">
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chat-input" placeholder="ãƒ›ãƒ¯ã‚¤ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼ã«ã¤ã„ã¦èããŸã„ã“ã¨ã‚’å…¥åŠ›...">
        <button class="chat-send" id="chat-send">é€ä¿¡</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  // MermaidåˆæœŸåŒ–
  mermaid.initialize({ theme: 'dark', background: '#0a0a14' });
  
  let currentDocContent = '';
  let currentDocType = 'whitepaper_jp';
  const docNames = {
    whitepaper: 'Whitepaper',
    whitepaper_jp: 'ãƒ›ãƒ¯ã‚¤ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼',
    readme: 'README'
  };
  
  // Marked.jsã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
  
  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿é–¢æ•°
  async function loadDocument(docType) {
    try {
      const docPaths = {
        whitepaper: 'docs/whitepaper.md',
        whitepaper_jp: 'docs/whitepaper_jp.md',
        readme: 'README.md'
      };
      
      const response = await fetch(docPaths[docType]);
      if (!response.ok) throw new Error(`Failed to fetch ${docType}`);
      
      const markdown = await response.text();
      currentDocContent = markdown;
      currentDocType = docType;
      
      // Marked.jsã§HTMLå¤‰æ›
      const rawHtml = marked.parse(markdown);
      // Sanitize document body â€” permissive config since content is our own markdown,
      // but still blocks script/iframe/event handlers as defense-in-depth
      const html = typeof DOMPurify !== 'undefined'
        ? DOMPurify.sanitize(rawHtml, {
            FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'form'],
            FORBID_ATTR: ['onerror', 'onclick', 'onload', 'onmouseover']
          })
        : rawHtml;
      document.getElementById('document-content').innerHTML = html;
      
      // Mermaidå›³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆé…åˆ—ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰for...ofã§é †æ¬¡å‡¦ç†ï¼‰
      const mermaidElements = [...document.querySelectorAll('.language-mermaid')];
      for (const [index, element] of mermaidElements.entries()) {
        const graphDefinition = element.textContent;
        const graphId = `mermaid-graph-${index}-${currentDocType}-${Date.now()}`;
        try {
          const { svg } = await mermaid.render(graphId, graphDefinition);
          // <pre><code class="language-mermaid">...</code></pre> â†’ <div class="mermaid">...</div>
          const preElement = element.closest('pre') || element.parentElement;
          preElement.outerHTML = `<div class="mermaid">${svg}</div>`;
        } catch (error) {
          console.error('Mermaid render error:', error);
        }
      }

      // è¦‹å‡ºã—ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ§ãƒ¼ãƒˆIDã‚’è¿½åŠ ï¼ˆä¾‹: id="41" for "4.1 ..."ï¼‰
      document.querySelectorAll('#document-content h1, #document-content h2, #document-content h3, #document-content h4').forEach(heading => {
        const match = heading.textContent.match(/^(\d[\d.]*)/);
        if (match) {
          const shortId = match[1].replace(/\./g, '');
          heading.setAttribute('id', shortId);
          // markedãŒç”Ÿæˆã—ãŸæ—¢å­˜idã‚‚ä¿æŒï¼ˆdataå±æ€§ã«é€€é¿ï¼‰
        }
      });

      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ã‚’SPAå¯¾å¿œ
      document.querySelectorAll('#document-content a[href^="#"]').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const id = link.getAttribute('href').slice(1);
          const target = document.getElementById(id);
          if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });

      // URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã®ã‚¸ãƒ£ãƒ³ãƒ—å¯¾å¿œ
      if (window.location.hash) {
        const id = window.location.hash.slice(1);
        const target = document.getElementById(id);
        if (target) setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      }

    } catch (error) {
      console.error(`Error loading ${docType}:`, error);
      document.getElementById('document-content').innerHTML = `
        <div style="text-align: center; color: #ff6b6b; margin: 50px 0;">
          <h2>ã‚¨ãƒ©ãƒ¼</h2>
          <p>${docType === 'whitepaper' ? 'ãƒ›ãƒ¯ã‚¤ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼' : 'README'}ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
          <p>ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      `;
    }
  }
  
  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
  document.querySelectorAll('.doc-tab').forEach(tab => {
    tab.addEventListener('click', async function() {
      const docType = this.dataset.doc;
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.doc-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿
      await loadDocument(docType);
      
      // ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ã®å¹ãå‡ºã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            checkApiKey(); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¹ãå‡ºã—æ›´æ–°
            updateChatLang();
    });
  });
  
  // åˆæœŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿
  await loadDocument('whitepaper_jp');
  
  // APIã‚­ãƒ¼å…¥åŠ›æ¬„ã®åˆæœŸåŒ–
  const wpApiKeyInput = document.getElementById('wp-api-key');
  const rememberCb = document.getElementById('rememberKeyCb');
  // obfuscateKey/deobfuscateKey loaded from common.js

  const isRemember = localStorage.getItem('xpathgenie_remember_key') === '1';
  rememberCb.checked = isRemember;
  if (isRemember) wpApiKeyInput.value = deobfuscateKey(localStorage.getItem('xpathgenie_api_key') || '');

  // API Key validation
  let validateTimer = null;
  function validateApiKey() {
    const key = wpApiKeyInput.value.trim();
    if (!key) { wpApiKeyInput.style.borderColor = ''; return; }
    if (validateTimer) clearTimeout(validateTimer);
    validateTimer = setTimeout(async () => {
      try {
        const res = await fetch(
          'https://generativelanguage.googleapis.com/v1beta/models?pageSize=1',
          { method: 'GET', headers: { 'x-goog-api-key': key } }
        );
        if (res.ok) {
          wpApiKeyInput.style.borderColor = '#22c55e';
          wpApiKeyInput.title = 'âœ… API key valid';
        } else {
          wpApiKeyInput.style.borderColor = '#ef4444';
          wpApiKeyInput.title = 'âŒ Invalid API key';
        }
      } catch {
        wpApiKeyInput.style.borderColor = '#f59e0b';
        wpApiKeyInput.title = 'âš ï¸ Connection error';
      }
    }, 500);
  }

  wpApiKeyInput.addEventListener('change', () => {
    const v = wpApiKeyInput.value.trim();
    if (rememberCb.checked) {
      if (v) localStorage.setItem('xpathgenie_api_key', obfuscateKey(v));
      else localStorage.removeItem('xpathgenie_api_key');
    }
    validateApiKey();
    checkApiKey();
  });

  wpApiKeyInput.addEventListener('blur', () => {
    validateApiKey();
  });

  rememberCb.addEventListener('change', () => {
    if (rememberCb.checked) {
      const isJpConfirm = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
      const confirmMsg = isJpConfirm
        ? 'âš ï¸ APIã‚­ãƒ¼ãŒlocalStorageã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã‚„XSSæ”»æ’ƒã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nã‚­ãƒ¼ã¯Google AI Studioã§ã„ã¤ã§ã‚‚å†ç”Ÿæˆã§ãã¾ã™ã€‚\n\nä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ'
        : 'âš ï¸ Your API key will be stored in localStorage.\n\nIt could be accessed by browser extensions or XSS attacks.\nYou can regenerate your key anytime at Google AI Studio.\n\nProceed?';
      const ok = confirm(confirmMsg);
      if (!ok) { rememberCb.checked = false; return; }
      localStorage.setItem('xpathgenie_remember_key', '1');
      const v = wpApiKeyInput.value.trim();
      if (v) localStorage.setItem('xpathgenie_api_key', obfuscateKey(v));
    } else {
      localStorage.setItem('xpathgenie_remember_key', '0');
      localStorage.removeItem('xpathgenie_api_key');
    }
  });

  // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
  const bubble = document.getElementById('jasmine-bubble');
  const chatInterface = document.getElementById('chat-interface');
  const chatClose = document.getElementById('chat-close');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const chatHistory = document.getElementById('chat-history');
  const bubbleTextA = document.getElementById('bubble-text-a');
  const bubbleTextB = document.getElementById('bubble-text-b');
  
  let chatMessages = [];

  const bubbleTextC = document.getElementById('bubble-text-c');

  function startBubbleRotation(defaultText, altHtml, clickText) {
    bubbleTextA.textContent = defaultText;
    bubbleTextB.innerHTML = altHtml;
    if (clickText) bubbleTextC.textContent = clickText;
    bubble.classList.add('rotating');
  }
  
  function stopBubbleRotation() {
    bubble.classList.remove('rotating');
    bubbleTextB.innerHTML = '';
  }

  // APIã‚­ãƒ¼ç¢ºèª
  let isLoading = false;

  function updateChatLang() {
    const isJp = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
    document.querySelector('.chat-header span').textContent = isJp
      ? 'ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ â€” ç ”ç©¶ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ' : 'Jasmine â€” Research Assistant';
    chatInput.placeholder = isJp
      ? `${docNames[currentDocType]}ã«ã¤ã„ã¦èããŸã„ã“ã¨ã‚’å…¥åŠ›...`
      : `Ask about the ${docNames[currentDocType]}...`;
    if (!isLoading) chatSend.textContent = isJp ? 'é€ä¿¡' : 'Send';
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
    const welcomeMsg = document.querySelector('.chat-history .chat-message.jasmine .chat-message-bubble');
    if (welcomeMsg && chatMessages.length === 0) {
      welcomeMsg.innerHTML = isJp
        ? 'æœ¬è«–æ–‡ã®å†…å®¹ã«ã¤ã„ã¦ã”è³ªå•ã‚’ãŠå—ã‘ã„ãŸã—ã¾ã™ã€‚<br>è©²å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ãªãŒã‚‰ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚'
        : 'I can answer your questions about this paper.<br>I will reference the relevant sections in my responses.';
    }
  }

  function checkApiKey() {
    const apiKey = wpApiKeyInput.value.trim() || deobfuscateKey(localStorage.getItem('xpathgenie_api_key') || '');
    if (!apiKey) {
      const defaultMsg = currentDocType === 'whitepaper_jp' || currentDocType === 'readme'
        ? `${docNames[currentDocType]}ã«ã¤ã„ã¦ã”è³ªå•ãŒã‚ã‚Œã°ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚`
        : `I can answer questions regarding this ${docNames[currentDocType]}.`;
      const isJp = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
      const altMsg = isJp
        ? 'ã”åˆ©ç”¨ã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼æ¬„ã«ã”å…¥åŠ›ãã ã•ã„ â†’ <a href="setup-guide.html" target="_blank" style="color:#ffffff; text-decoration:underline;">å–å¾—æ–¹æ³•</a>'
        : 'An API key is required. Please enter it in the header â†’ <a href="setup-guide.html" target="_blank" style="color:#ffffff; text-decoration:underline;">Get one</a>';
      const clickMsg = isJp
        ? 'ã€Œã“ã®å¹ãå‡ºã—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚'
        : 'Click this bubble to start.';
      startBubbleRotation(defaultMsg, altMsg, clickMsg);
      return null;
    }
    stopBubbleRotation();
    const isJp = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
    bubbleTextA.textContent = isJp
      ? `${docNames[currentDocType]}ã«ã¤ã„ã¦ã”è³ªå•ãŒã‚ã‚Œã°ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚`
      : `I can answer questions regarding this ${docNames[currentDocType]}.`;
    return apiKey;
  }
  
  // ãƒãƒ£ãƒƒãƒˆé–‹é–‰
  bubble.addEventListener('click', function(e) {
    // ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ã¯ãã®ã¾ã¾é€šã™
    if (e.target.tagName === 'A') return;
    const apiKey = checkApiKey();
    if (!apiKey) {
      // APIã‚­ãƒ¼ãªã—â†’å³åº§ã«altãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      stopBubbleRotation();
      const isJp2 = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
      bubbleTextA.innerHTML = isJp2
        ? 'ã”åˆ©ç”¨ã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼æ¬„ã«ã”å…¥åŠ›ãã ã•ã„ â†’ <a href="setup-guide.html" target="_blank" style="color:#ffffff; text-decoration:underline;">å–å¾—æ–¹æ³•</a>'
        : 'An API key is required. Please enter it in the header â†’ <a href="setup-guide.html" target="_blank" style="color:#ffffff; text-decoration:underline;">Get one</a>';
      return;
    }
    chatInterface.classList.add('active');
    bubble.style.display = 'none';
  });
  
  chatClose.addEventListener('click', function() {
    chatInterface.classList.remove('active');
    bubble.style.display = 'block';
  });
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
  function addMessage(text, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user' : 'jasmine'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'chat-message-bubble';
    
    if (isUser) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆXSSé˜²æ­¢ï¼‰
      bubbleDiv.textContent = text;
    } else {
      // ã‚¸ãƒ£ã‚¹ãƒŸãƒ³ã®è¿”ç­”ã¯Markdownã‚’HTMLã«å¤‰æ›
      try {
        const html = DOMPurify.sanitize(marked.parse(text));
        bubbleDiv.innerHTML = html;
        
        // ãƒªãƒ³ã‚¯ã®å‡¦ç†: ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯ã¯ãã®ã¾ã¾ã€å¤–éƒ¨ãƒªãƒ³ã‚¯ã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        const links = bubbleDiv.querySelectorAll('a');
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (href && href.startsWith('#')) {
            // ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯: SPAå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const id = href.slice(1);
              const target = document.getElementById(id);
              if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
              // ãƒãƒ£ãƒƒãƒˆã‚’é–‰ã˜ã‚‹
              document.getElementById('chat-interface').classList.remove('active');
              document.getElementById('jasmine-bubble').style.display = 'block';
            });
          } else if (href && (href.startsWith('http') || href.startsWith('https'))) {
            // å¤–éƒ¨ãƒªãƒ³ã‚¯: æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          }
        });
      } catch (error) {
        console.error('Markdown parse error:', error);
        bubbleDiv.textContent = text;
      }
    }
    
    messageDiv.appendChild(bubbleDiv);
    chatHistory.appendChild(messageDiv);
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸‹éƒ¨ã«
    chatHistory.scrollTop = chatHistory.scrollHeight;
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«ä¿å­˜ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ï¼‰
    chatMessages.push({
      role: isUser ? 'user' : 'model',
      parts: [{ text: text }]
    });
  }
  
  // ãƒãƒ£ãƒƒãƒˆé€ä¿¡
  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    const apiKey = checkApiKey();
    if (!apiKey) return;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    addMessage(message, true);
    chatInput.value = '';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    chatSend.disabled = true;
    const isJpSend = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
    chatSend.textContent = isJpSend ? 'é€ä¿¡ä¸­...' : 'Sending...';
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆchatMessagesã«ã¯è¿½åŠ ã—ãªã„ï¼‰
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-message jasmine';
    loadingDiv.id = 'loading-message';
    const isJpLoad = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
    loadingDiv.innerHTML = `<div class="chat-message-bubble"><em>${isJpLoad ? 'è€ƒãˆä¸­...ğŸ’­' : 'Thinking...ğŸ’­'}</em></div>`;
    chatHistory.appendChild(loadingDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    
    try {
      // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
      const isJpDoc = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
      
      const systemPrompt = isJpDoc 
        ? `ã‚ãªãŸã¯XPathGenieãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç ”ç©¶ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€Œã‚¸ãƒ£ã‚¹ãƒŸãƒ³ã€ã§ã™ã€‚
ä»¥ä¸‹ã®${docNames[currentDocType]}ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æ—¥æœ¬èªã§ä¸å¯§ã«ãŠç­”ãˆãã ã•ã„ã€‚
å­¦è¡“çš„ã§æ­£ç¢ºãªè¡¨ç¾ã‚’å¿ƒãŒã‘ã€æ ¹æ‹ ã«åŸºã¥ã„ãŸèª¬æ˜ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚å†…å®¹ã«è¨˜è¼‰ãŒãªã„äº‹é …ã«ã¤ã„ã¦ã¯ã€Œ${docNames[currentDocType]}ã§ã¯è¨€åŠã•ã‚Œã¦ãŠã‚Šã¾ã›ã‚“ã€ã¨ç‡ç›´ã«ãŠä¼ãˆãã ã•ã„ã€‚

ã€é‡è¦ã€‘å›ç­”ã™ã‚‹éš›ã¯ã€è©²å½“ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚
ä¾‹: ã€Œã“ã®ç‚¹ã«ã¤ã„ã¦ã¯Section 3.4ï¼ˆäºŒæ®µéšç²¾ç·»åŒ–ï¼‰ã«ã¦è©³è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚ã€
ãƒšãƒ¼ã‚¸å†…ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ã‚‚ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚IDã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã®ãƒ‰ãƒƒãƒˆã‚’é™¤ã„ãŸæ•°å­—ã§ã™ã€‚ä¾‹: [Section 3.4](#34)

å›ç­”ã¯Markdownå½¢å¼ã§ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

[${docNames[currentDocType]}å…¨æ–‡]
${currentDocContent}`
        : `You are "Jasmine", a research assistant for the XPathGenie project.
Answer the user's questions based on the ${docNames[currentDocType]} content below.
Use a professional, academic tone with precise and evidence-based explanations. If something isn't covered, state clearly: "That is not addressed in the ${docNames[currentDocType]}."

IMPORTANT: When answering, reference the relevant section numbers.
Example: "This is discussed in Section 3.4 (Two-Tier Refinement)."
Include anchor links so users can click to jump there. IDs are section numbers without dots. Example: [Section 3.4](#34)

Use Markdown formatting. Be concise.

[${docNames[currentDocType]} full text]
${currentDocContent}`;
      
      // Gemini APIå‘¼ã³å‡ºã—
      const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': apiKey,
        },
        body: JSON.stringify({
          contents: [
            {
              role: 'user',
              parts: [{ text: systemPrompt }]
            },
            ...chatMessages
          ],
          generationConfig: {
            temperature: 0.9,
            topK: 1,
            topP: 1,
            maxOutputTokens: 2048,
          }
        })
      });
      
      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }
      
      const data = await response.json();
      const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'ã™ã¿ã¾ã›ã‚“ã€ã†ã¾ãç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ...';
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      const loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) loadingMsg.remove();
      
      // AIå›ç­”ã‚’è¡¨ç¤º
      addMessage(aiResponse, false);
      
    } catch (error) {
      console.error('Chat error:', error);
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      const loadingMsg2 = document.getElementById('loading-message');
      if (loadingMsg2) loadingMsg2.remove();
      
      const isJpErr = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme');
      addMessage(isJpErr
        ? 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ã”ç¢ºèªãã ã•ã„ã€‚'
        : 'An error occurred. Please verify your API key is correct.', false);
    } finally {
      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
      chatSend.disabled = false;
      chatSend.textContent = (currentDocType === 'whitepaper_jp' || currentDocType === 'readme') ? 'é€ä¿¡' : 'Send';
    }
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  chatSend.addEventListener('click', sendMessage);
  
  chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // åˆæœŸAPIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
  checkApiKey();
  updateChatLang();
});
</script>

</body>
</html>